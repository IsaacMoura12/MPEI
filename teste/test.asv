ufile = load('u.data');
ufilms = ufile(1:end,1:3);
users = unique(ufile(:,1));
dicFilms = readcell('films.txt','Delimiter', '\t');
films = dicFilms(:,1);

Nu = length(users);
YourMoviesTable = cell(Nu, 1);

k= 100;
MinHashCat = inf(length(dicFilms),k);

Nc = length(dicFilms);

allcategories = strings(1,19);
Nallc = 19;
it = 1;
for i = 1:length(dicFilms)
    categorias = rmmissing(string(dicFilms(i,2:end)));
    for x = 1: length(categorias)
        categoria = categorias(x);
        if ~ismember(categoria,allcategories)
            allcategories(it) = categoria;
            it = it +1;
        end
    end
end

MinHashallCat = inf(length(allcategories),k);

for i = 1:Nc
    conjunto = allcategories(i); 
    for j = 1:length(conjunto)
        chave = char(conjunto(j));
        hash = zeros(1,k);
        for kk = 1:k
            chave = [chave num2str(kk)];
            hash(kk) = DJB31MA(chave,127);
        end
        MinHashallCat(i,:) = min([MinHashallCat(i,:); hash]);  % Valor minimo da hash para este título
    end
end

MinHashCat = inf(Nc,k);

for i = 1:Nc
    conjunto = rmmissing(string(dicFilms(i,2:end)));
    pos = [];
    for j = 1:length(conjunto)
        categoria = char(conjunto(j));
        pos = [pos find(allcategories == categoria)];
    end 
    for kk = 1:length(pos)
        MinHashCat(i,:) = min([MinHashallCat(i,:); hash]);  % Valor minimo da hash para este título
    end
    MinHashCat(i,:) = min([MinHashallCat(i,:); hash]);  
end

%{
for i = 1:length(dicFilms)
    conjunto = dicFilms(i,2:end);
    mask = cellfun(@(x) any(isa(x,'missing')), conjunto);
    conjuntofilter = sum(~mask);
    ifilter = 0;
    for j = 1:length(conjunto)
        if mask(j) == 0
            %chave = [chave char(conjunto(j))];
            conjuntofilter(ifilter)= chave;
            chave = [chave char(conjuntofilter(j))];
            ifilter = ifilter + 1;
        end
    end
    for x = 1:length(conjuntofilter)
        hash = zeros(1,k);
        for kk = 1:k
            chave = [chave num2str(kk)];
            hash(kk) = DJB31MA(chave,127);

        end
        MinHashCat(i,:) = min([MinHashCat(i,:); hash]); 
end

tic
J=zeros(Nc);
h=waitbar(0, 'Calculating');
n2 =2;
for n1 = 1:Nc
    waitbar(n1/Nc, h);
    if n2 ~= n1
        J(n1,n2) = sum(MinHashCat(n1,:) ~= MinHashCat(n2,:))/k;
    end
end
fprintf('Tempo de calculo das distancias dadas por MinHash= %f\n',toc);
delete (h)


tic
threshold = 0.8;
SimilarMovies = cell(1,3);
k = 1;
for n1 = 1:Nc
    if J(n1,n2) < threshold
        SimilarMovies(k,:) = {char(films(n1)) char(films(n2)) J(n1,n2)};
        k = k+1;
    end
end
fprintf('Tempo de caluclo dos filmes mais similares= %f\n', toc);
fprintf('No de pares mais similares= %d\n', size(SimilarMovies, 1));



%%%%%%%%%%%%%%%%%%%%%%%%%5


categorias = dicFilms(1:end,2:end);
categoriasstr = string(categorias);
%mask = cellfun(@(x) any(isa(x,'missing')), categorias);

n2= 2;
linhauser = rmmissing(categoriasstr(n2,:));
J=zeros(Nc);
h=waitbar(0, 'Calculating');
count = 0;
for n1 = 1:Nc
    count = 0;
    waitbar(n1/Nc, h);
    linha1 = rmmissing(categoriasstr(n1,:));
    if n2 ~= n1
        for iu = 1:length(linhauser)
            for i1 = length(linha1)
                if linhauser(iu) == linha1(i1)
                    count = count +1;
                end
            end
        end
        diferentes = length(linhauser) + length(linha1) -count;
       J(n1,n2) = diferentes / (diferentes + count);
    end
end


threshold = 0.8;
SimilarMovies = cell(1,3);
k = 1;
for n1 = 1:Nc
    if J(n1,n2) < threshold
        SimilarMovies(k,:) = {char(films(n1)) char(films(n2)) J(n1,n2)};
        k = k+1;
    end
end

fprintf('No de pares com distancia de Jaccard inferior a 0.8= %d\n', size(SimilarMovies, 1));

%}


